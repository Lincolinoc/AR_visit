<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>WebAR –≤–∏–∑–∏—Ç–∫–∞</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@latest/dist/aframe-extras.loaders.min.js"></script>
    <style>
      body { 
        margin: 0; 
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      .ui-panel {
        position: absolute;
        z-index: 5;
        background: rgba(255,255,255,0.95);
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      }
      #loading {
        left: 10px;
        top: 10px;
      }
      #markerSwitch {
        right: 10px;
        top: 10px;
        cursor: pointer;
        user-select: none;
      }
      #markerSwitch:hover {
        background: rgba(200,220,255,0.95);
      }
      #debug {
        position: absolute;
        z-index: 5;
        left: 10px;
        bottom: 10px;
        background: rgba(0,0,0,0.9);
        color: #0f0;
        padding: 10px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        max-width: 90%;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #0f0;
      }
      .error { color: #ff5555; }
      .warning { color: #ffaa00; }
      .success { color: #00ff00; }
    </style>
  </head>
  <body>
    <div id="loading" class="ui-panel">üì∑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã...</div>
    <div id="markerSwitch" class="ui-panel">üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ Hiro</div>
    <div id="debug"></div>
    
    <a-scene 
      embedded 
      arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; precision: medium;">
      
      <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Ä–∫–µ—Ä -->
      <a-marker 
        type="pattern" 
        url="mycard.patt" 
        id="customMarker"
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.01"
        smoothThreshold="5"
        raycaster="objects: .clickable">
        
        <a-box 
          color="#4169E1" 
          position="0 0.5 0" 
          scale="0.5 0.5 0.5"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 4000">
        </a-box>
        
        <a-entity 
          obj-model="obj: url(model.obj); mtl: url(model.mtl)"
          scale="2 2 2"
          rotation="0 180 0"
          position="0 0 0">
        </a-entity>
        
        <a-entity position="0 1.2 0" rotation="-15 0 0">
          <a-text 
            value="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤\n–î–∏–∑–∞–π–Ω–µ—Ä" 
            align="center" 
            width="1.8"
            color="#000000"
            shader="sdf"
            font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
          </a-text>
        </a-entity>
      </a-marker>
      
      <!-- –¢–µ—Å—Ç–æ–≤—ã–π Hiro –º–∞—Ä–∫–µ—Ä -->
      <a-marker 
        preset="hiro" 
        id="hiroMarker"
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.01"
        smoothThreshold="5">
        
        <a-box 
          color="#FF4136" 
          position="0 0.5 0" 
          scale="0.5 0.5 0.5"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 4000">
        </a-box>
        
        <a-entity 
          obj-model="obj: url(model.obj); mtl: url(model.mtl)"
          scale="2 2 2"
          rotation="0 180 0"
          position="0 0 0">
        </a-entity>
        
        <a-entity position="0 1.2 0" rotation="-15 0 0">
          <a-text 
            value="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤\n–î–∏–∑–∞–π–Ω–µ—Ä\n(HIRO TEST)" 
            align="center" 
            width="1.8"
            color="#000000"
            shader="sdf"
            font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
          </a-text>
        </a-entity>
      </a-marker>
      
      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const loading = document.getElementById('loading');
      const debug = document.getElementById('debug');
      const markerSwitch = document.getElementById('markerSwitch');
      
      let useCustomMarker = true;
      let cameraReady = false;
      let customMarkerLoaded = false;
      let customMarkerError = false;

      function log(msg, type = 'info') {
        console.log(msg);
        const time = new Date().toLocaleTimeString();
        const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : '';
        debug.innerHTML += `<span class="${className}">[${time}] ${msg}</span><br>`;
        debug.scrollTop = debug.scrollHeight;
      }

      log('‚úì –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
      const ua = navigator.userAgent;
      const device = ua.match(/iPhone|iPad/) ? 'iOS' : ua.match(/Android/) ? 'Android' : 'Desktop';
      log('üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ' + device);

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
      function switchMarker() {
        if (customMarkerError) {
          log('‚ö† –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Ä–∫–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'warning');
          return;
        }

        useCustomMarker = !useCustomMarker;
        const customMarker = document.getElementById('customMarker');
        const hiroMarker = document.getElementById('hiroMarker');
        
        customMarker.object3D.visible = useCustomMarker;
        hiroMarker.object3D.visible = !useCustomMarker;
        
        if (useCustomMarker) {
          markerSwitch.textContent = 'üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ Hiro';
          loading.textContent = 'üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –í–ê–®–£ –≤–∏–∑–∏—Ç–∫—É';
          log('üîÑ –ê–∫—Ç–∏–≤–µ–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Ä–∫–µ—Ä', 'success');
        } else {
          markerSwitch.textContent = 'üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–æ—é';
          loading.textContent = 'üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ HIRO –º–∞—Ä–∫–µ—Ä';
          log('üîÑ –ê–∫—Ç–∏–≤–µ–Ω Hiro –º–∞—Ä–∫–µ—Ä (—Ç–µ—Å—Ç)', 'success');
        }
      }

      markerSwitch.addEventListener('click', switchMarker);

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã
      const scene = document.querySelector('a-scene');
      
      scene.addEventListener('loaded', () => {
        log('‚úì A-Frame —Å—Ü–µ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
      });

      scene.addEventListener('renderstart', () => {
        log('‚úì –†–µ–Ω–¥–µ—Ä –∑–∞–ø—É—â–µ–Ω', 'success');
      });

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã
      const checkCamera = setInterval(() => {
        const video = document.querySelector('video');
        if (video && video.videoWidth > 0 && !cameraReady) {
          cameraReady = true;
          log(`‚úì –ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞: ${video.videoWidth}x${video.videoHeight}`, 'success');
          loading.textContent = 'üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –≤–∏–∑–∏—Ç–∫—É';
          loading.style.background = 'rgba(100,200,100,0.95)';
          clearInterval(checkCamera);
        }
      }, 500);

      setTimeout(() => {
        if (!cameraReady) {
          log('‚úó –ö–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å –∑–∞ 10 —Å–µ–∫', 'error');
          loading.textContent = '‚ö† –ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–∞–º–µ—Ä–æ–π. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É';
          loading.style.background = 'rgba(255,100,0,0.95)';
        }
        clearInterval(checkCamera);
      }, 10000);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
      const customMarker = document.getElementById('customMarker');
      const hiroMarker = document.getElementById('hiroMarker');
      
      // –°–∫—Ä—ã–≤–∞–µ–º Hiro –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      setTimeout(() => {
        if (hiroMarker && hiroMarker.object3D) {
          hiroMarker.object3D.visible = false;
        }
      }, 100);

      customMarker.addEventListener('markerFound', () => {
        log('üéØ –ö–ê–°–¢–û–ú–ù–´–ô –ú–ê–†–ö–ï–† –ù–ê–ô–î–ï–ù!', 'success');
        loading.textContent = '‚úÖ –í–∞—à –º–∞—Ä–∫–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!';
        loading.style.background = 'rgba(0,255,0,0.95)';
      });

      customMarker.addEventListener('markerLost', () => {
        log('üìç –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Ä–∫–µ—Ä –ø–æ—Ç–µ—Ä—è–Ω');
        loading.textContent = 'üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –≤–∏–∑–∏—Ç–∫—É';
        loading.style.background = 'rgba(100,200,100,0.95)';
      });

      hiroMarker.addEventListener('markerFound', () => {
        log('üéØ HIRO –ú–ê–†–ö–ï–† –ù–ê–ô–î–ï–ù!', 'success');
        loading.textContent = '‚úÖ Hiro –º–∞—Ä–∫–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!';
        loading.style.background = 'rgba(0,255,255,0.95)';
      });

      hiroMarker.addEventListener('markerLost', () => {
        log('üìç Hiro –º–∞—Ä–∫–µ—Ä –ø–æ—Ç–µ—Ä—è–Ω');
        loading.textContent = 'üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ Hiro –º–∞—Ä–∫–µ—Ä';
        loading.style.background = 'rgba(100,200,100,0.95)';
      });

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤
      async function checkFile(url, fileType) {
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const text = await response.text();
          
          if (fileType === 'patt') {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ .patt —Ñ–∞–π–ª–∞
            const lines = text.split('\n').filter(l => l.trim());
            const hasNumbers = /\d/.test(text);
            
            if (text.length < 100) {
              log(`‚ö† ${url}: —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª (${text.length} –±–∞–π—Ç)`, 'warning');
              return false;
            }
            if (lines.length < 10) {
              log(`‚ö† ${url}: —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ —Å—Ç—Ä–æ–∫ (${lines.length})`, 'warning');
              return false;
            }
            if (!hasNumbers) {
              log(`‚ö† ${url}: –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —á–∏—Å–ª–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö`, 'warning');
              return false;
            }
            
            log(`‚úì ${url} –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (${text.length} –±–∞–π—Ç, ${lines.length} —Å—Ç—Ä–æ–∫)`, 'success');
            return true;
          } else {
            log(`‚úì ${url} –Ω–∞–π–¥–µ–Ω (${text.length} –±–∞–π—Ç)`, 'success');
            return true;
          }
        } catch (err) {
          log(`‚úó ${url} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${err.message}`, 'error');
          return false;
        }
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
      (async () => {
        const pattOk = await checkFile('mycard.patt', 'patt');
        await checkFile('model.obj', 'model');
        await checkFile('model.mtl', 'model');

        if (!pattOk) {
          customMarkerError = true;
          log('‚ö† –í–ù–ò–ú–ê–ù–ò–ï: –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Ä–∫–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω', 'warning');
          log('‚ÑπÔ∏è  –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Hiro –º–∞—Ä–∫–µ—Ä –¥–ª—è —Ç–µ—Å—Ç–∞', 'warning');
          
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ Hiro
          setTimeout(() => {
            switchMarker();
            markerSwitch.style.background = 'rgba(255,255,0,0.95)';
          }, 1000);
        } else {
          customMarkerLoaded = true;
        }
      })();

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
      if (location.protocol === 'https:') {
        log('‚úì HTTPS –∞–∫—Ç–∏–≤–µ–Ω', 'success');
      } else {
        log('‚ö† –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HTTP (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è HTTPS)', 'warning');
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
      let errorCount = 0;
      const criticalErrors = new Set();
      
      window.addEventListener('error', (e) => {
        const msg = e.message || e.error?.message || 'Unknown error';
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
        if (criticalErrors.has(msg)) return;
        criticalErrors.add(msg);
        
        errorCount++;
        if (errorCount <= 5) {
          log(`‚úó –û—à–∏–±–∫–∞: ${msg.substring(0, 80)}`, 'error');
        }
        
        // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
        if (msg.includes('memory access out of bounds') || msg.includes('divide by zero')) {
          log('‚ö† –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–∞–π–ª–æ–º –º–∞—Ä–∫–µ—Ä–∞!', 'error');
          log('‚ÑπÔ∏è  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç mycard.patt –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Hiro', 'warning');
          
          customMarkerError = true;
          markerSwitch.style.background = 'rgba(255,100,100,0.95)';
          markerSwitch.textContent = '‚ö† –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Hiro';
          loading.textContent = '‚ö† –û—à–∏–±–∫–∞ –º–∞—Ä–∫–µ—Ä–∞. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Å–ø—Ä–∞–≤–∞';
          loading.style.background = 'rgba(255,100,0,0.95)';
        }
      });

      // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      setTimeout(() => {
        if (!customMarkerError && !customMarkerLoaded) {
          log('‚ÑπÔ∏è  –ï—Å–ª–∏ –º–∞—Ä–∫–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:', 'warning');
          log('  1. –£–ª—É—á—à–∏—Ç—å –æ—Å–≤–µ—â–µ–Ω–∏–µ');
          log('  2. –î–µ—Ä–∂–∞—Ç—å –∫–∞–º–µ—Ä—É —Ä–æ–≤–Ω–µ–µ');
          log('  3. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ Hiro –¥–ª—è —Ç–µ—Å—Ç–∞');
        }
      }, 5000);
    </script>
  </body>
</html>
