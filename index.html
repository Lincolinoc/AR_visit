<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>WebAR –≤–∏–∑–∏—Ç–∫–∞</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@latest/dist/aframe-extras.loaders.min.js"></script>
    <style>
      body { 
        margin: 0; 
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      .ui-panel {
        position: absolute;
        z-index: 5;
        background: rgba(255,255,255,0.95);
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      }
      #loading {
        left: 10px;
        top: 10px;
      }
      #markerSwitch {
        right: 10px;
        top: 10px;
        cursor: pointer;
        user-select: none;
      }
      #markerSwitch:hover {
        background: rgba(200,220,255,0.95);
      }
      #debug {
        position: absolute;
        z-index: 5;
        left: 10px;
        bottom: 10px;
        background: rgba(0,0,0,0.9);
        color: #0f0;
        padding: 10px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        max-width: 90%;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #0f0;
      }
      #instructions {
        position: absolute;
        z-index: 5;
        right: 10px;
        bottom: 10px;
        background: rgba(50,50,255,0.95);
        color: white;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 12px;
        max-width: 200px;
      }
      .error { color: #ff5555; }
      .warning { color: #ffaa00; }
      .success { color: #00ff00; }
    </style>
  </head>
  <body>
    <div id="loading" class="ui-panel">üì∑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã...</div>
    <div id="markerSwitch" class="ui-panel">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–≤–æ–π –º–∞—Ä–∫–µ—Ä</div>
    <div id="instructions">
      üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Hiro –º–∞—Ä–∫–µ—Ä<br>
      <a href="https://github.com/AR-js-org/AR.js/raw/master/data/images/hiro.png" 
         target="_blank" 
         style="color: #ffff00;">
        üì• –°–∫–∞—á–∞—Ç—å Hiro
      </a>
    </div>
    <div id="debug"></div>
    
    <a-scene 
      embedded 
      arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; precision: medium;">
      
      <!-- HIRO –º–∞—Ä–∫–µ—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–∫—Ç–∏–≤–µ–Ω) -->
      <a-marker 
        preset="hiro" 
        id="hiroMarker"
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.01"
        smoothThreshold="5">
        
        <a-box 
          color="#FF4136" 
          position="0 0.5 0" 
          scale="0.5 0.5 0.5"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 4000">
        </a-box>
        
        <a-entity 
          obj-model="obj: url(model.obj); mtl: url(model.mtl)"
          scale="2 2 2"
          rotation="0 180 0"
          position="0 0 0">
        </a-entity>
        
        <a-entity position="0 1.2 0" rotation="-15 0 0">
          <a-text 
            value="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤\n–î–∏–∑–∞–π–Ω–µ—Ä" 
            align="center" 
            width="1.8"
            color="#000000"
            shader="sdf"
            font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
          </a-text>
        </a-entity>
      </a-marker>
      
      <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Ä–∫–µ—Ä (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω) -->
      <a-marker 
        type="pattern" 
        url="mycard.patt" 
        id="customMarker"
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.01"
        smoothThreshold="5"
        raycaster="objects: .clickable"
        visible="false">
        
        <a-box 
          color="#4169E1" 
          position="0 0.5 0" 
          scale="0.5 0.5 0.5"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 4000">
        </a-box>
        
        <a-entity 
          obj-model="obj: url(model.obj); mtl: url(model.mtl)"
          scale="2 2 2"
          rotation="0 180 0"
          position="0 0 0">
        </a-entity>
        
        <a-entity position="0 1.2 0" rotation="-15 0 0">
          <a-text 
            value="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤\n–î–∏–∑–∞–π–Ω–µ—Ä\n(–ú–æ–π –º–∞—Ä–∫–µ—Ä)" 
            align="center" 
            width="1.8"
            color="#000000"
            shader="sdf"
            font="https://cdn.aframe.io/fonts/Roboto-msdf.json">
          </a-text>
        </a-entity>
      </a-marker>
      
      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const loading = document.getElementById('loading');
      const debug = document.getElementById('debug');
      const markerSwitch = document.getElementById('markerSwitch');
      const instructions = document.getElementById('instructions');
      
      let useCustomMarker = false; // –ù–∞—á–∏–Ω–∞–µ–º —Å Hiro!
      let cameraReady = false;
      let customMarkerTested = false;
      let customMarkerWorks = false;

      function log(msg, type = 'info') {
        console.log(msg);
        const time = new Date().toLocaleTimeString();
        const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : '';
        debug.innerHTML += `<span class="${className}">[${time}] ${msg}</span><br>`;
        debug.scrollTop = debug.scrollHeight;
      }

      log('‚úì –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
      log('üéØ –ó–∞–ø—É—Å–∫ —Å Hiro –º–∞—Ä–∫–µ—Ä–æ–º (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º)', 'success');
      
      const ua = navigator.userAgent;
      const device = ua.match(/iPhone|iPad/) ? 'iOS' : ua.match(/Android/) ? 'Android' : 'Desktop';
      log('üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ' + device);

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
      function switchMarker() {
        if (!customMarkerTested) {
          log('‚ÑπÔ∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞...', 'warning');
          loading.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞...';
          loading.style.background = 'rgba(255,200,0,0.95)';
        }

        useCustomMarker = !useCustomMarker;
        const customMarker = document.getElementById('customMarker');
        const hiroMarker = document.getElementById('hiroMarker');
        
        if (useCustomMarker) {
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω—ã–π
          customMarker.setAttribute('visible', 'true');
          hiroMarker.setAttribute('visible', 'false');
          
          markerSwitch.textContent = 'üîÑ –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ Hiro';
          loading.textContent = 'üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –í–ê–®–£ –≤–∏–∑–∏—Ç–∫—É';
          instructions.innerHTML = 'üí° –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–∞—à –º–∞—Ä–∫–µ—Ä';
          log('üîÑ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Ä–∫–µ—Ä', 'success');
          
          customMarkerTested = true;
        } else {
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ Hiro
          customMarker.setAttribute('visible', 'false');
          hiroMarker.setAttribute('visible', 'true');
          
          markerSwitch.textContent = 'üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–≤–æ–π –º–∞—Ä–∫–µ—Ä';
          loading.textContent = 'üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ HIRO –º–∞—Ä–∫–µ—Ä';
          instructions.innerHTML = `üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Hiro –º–∞—Ä–∫–µ—Ä<br>
            <a href="https://github.com/AR-js-org/AR.js/raw/master/data/images/hiro.png" 
               target="_blank" 
               style="color: #ffff00;">
              üì• –°–∫–∞—á–∞—Ç—å Hiro
            </a>`;
          log('üîÑ –í–æ–∑–≤—Ä–∞—Ç –∫ Hiro –º–∞—Ä–∫–µ—Ä—É', 'success');
        }
      }

      markerSwitch.addEventListener('click', switchMarker);

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã
      const scene = document.querySelector('a-scene');
      
      scene.addEventListener('loaded', () => {
        log('‚úì A-Frame —Å—Ü–µ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
      });

      scene.addEventListener('renderstart', () => {
        log('‚úì –†–µ–Ω–¥–µ—Ä –∑–∞–ø—É—â–µ–Ω', 'success');
      });

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã
      const checkCamera = setInterval(() => {
        const video = document.querySelector('video');
        if (video && video.videoWidth > 0 && !cameraReady) {
          cameraReady = true;
          log(`‚úì –ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞: ${video.videoWidth}x${video.videoHeight}`, 'success');
          loading.textContent = 'üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ Hiro –º–∞—Ä–∫–µ—Ä';
          loading.style.background = 'rgba(100,200,100,0.95)';
          clearInterval(checkCamera);
        }
      }, 500);

      setTimeout(() => {
        if (!cameraReady) {
          log('‚úó –ö–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å –∑–∞ 10 —Å–µ–∫', 'error');
          loading.textContent = '‚ö† –ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–∞–º–µ—Ä–æ–π. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É';
          loading.style.background = 'rgba(255,100,0,0.95)';
        }
        clearInterval(checkCamera);
      }, 10000);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
      const customMarker = document.getElementById('customMarker');
      const hiroMarker = document.getElementById('hiroMarker');

      hiroMarker.addEventListener('markerFound', () => {
        log('üéØ HIRO –ú–ê–†–ö–ï–† –ù–ê–ô–î–ï–ù!', 'success');
        loading.textContent = '‚úÖ Hiro –º–∞—Ä–∫–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!';
        loading.style.background = 'rgba(0,255,0,0.95)';
      });

      hiroMarker.addEventListener('markerLost', () => {
        log('üìç Hiro –º–∞—Ä–∫–µ—Ä –ø–æ—Ç–µ—Ä—è–Ω');
        loading.textContent = 'üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ Hiro –º–∞—Ä–∫–µ—Ä';
        loading.style.background = 'rgba(100,200,100,0.95)';
      });

      customMarker.addEventListener('markerFound', () => {
        log('üéØ –ö–ê–°–¢–û–ú–ù–´–ô –ú–ê–†–ö–ï–† –ù–ê–ô–î–ï–ù!', 'success');
        loading.textContent = '‚úÖ –í–∞—à –º–∞—Ä–∫–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!';
        loading.style.background = 'rgba(0,255,0,0.95)';
        customMarkerWorks = true;
        
        instructions.innerHTML = '‚úÖ –í–∞—à –º–∞—Ä–∫–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!';
        markerSwitch.style.background = 'rgba(0,255,0,0.95)';
      });

      customMarker.addEventListener('markerLost', () => {
        log('üìç –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Ä–∫–µ—Ä –ø–æ—Ç–µ—Ä—è–Ω');
        loading.textContent = 'üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –≤–∏–∑–∏—Ç–∫—É';
        loading.style.background = 'rgba(100,200,100,0.95)';
      });

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ (–≤ —Ñ–æ–Ω–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫)
      async function checkFile(url) {
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const text = await response.text();
          log(`‚úì ${url} –Ω–∞–π–¥–µ–Ω (${text.length} –±–∞–π—Ç)`, 'success');
          return true;
        } catch (err) {
          log(`‚ö† ${url} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${err.message}`, 'warning');
          return false;
        }
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
      setTimeout(() => {
        checkFile('model.obj');
        checkFile('model.mtl');
        
        checkFile('mycard.patt').then(exists => {
          if (!exists) {
            log('‚ÑπÔ∏è  –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Ä–∫–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Hiro', 'warning');
            markerSwitch.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
          }
        });
      }, 2000);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
      if (location.protocol === 'https:') {
        log('‚úì HTTPS –∞–∫—Ç–∏–≤–µ–Ω', 'success');
      } else {
        log('‚ö† –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HTTP (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è HTTPS)', 'warning');
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
      let errorCount = 0;
      const criticalErrors = new Set();
      
      window.addEventListener('error', (e) => {
        const msg = e.message || e.error?.message || 'Unknown error';
        
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –æ—à–∏–±–∫–∏
        if (criticalErrors.has(msg)) return;
        criticalErrors.add(msg);
        
        errorCount++;
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –±–µ–∑–≤—Ä–µ–¥–Ω—ã–µ –æ—à–∏–±–∫–∏
        if (msg.includes('message channel closed')) {
          log('‚ÑπÔ∏è  –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞', 'warning');
          return;
        }
        
        if (errorCount <= 5) {
          log(`‚úó –û—à–∏–±–∫–∞: ${msg.substring(0, 80)}`, 'error');
        }
        
        // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –º–∞—Ä–∫–µ—Ä–∞
        if (msg.includes('memory access out of bounds') || msg.includes('divide by zero')) {
          log('‚ö† –û–®–ò–ë–ö–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –º–∞—Ä–∫–µ—Ä–æ–º!', 'error');
          log('‚ÑπÔ∏è  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Hiro - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
          
          // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
          markerSwitch.style.display = 'none';
          instructions.innerHTML = '‚ö† –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Ä–∫–µ—Ä –ø–æ–≤—Ä–µ–∂–¥—ë–Ω<br>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Hiro';
          
          // –ï—Å–ª–∏ —Å–ª—É—á–∞–π–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ Hiro
          if (useCustomMarker) {
            setTimeout(() => {
              document.getElementById('customMarker').setAttribute('visible', 'false');
              document.getElementById('hiroMarker').setAttribute('visible', 'true');
              useCustomMarker = false;
              loading.textContent = 'üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ Hiro –º–∞—Ä–∫–µ—Ä';
            }, 100);
          }
        }
      });

      // –ü–æ–¥—Å–∫–∞–∑–∫–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
      setTimeout(() => {
        log('üí° –°–æ–≤–µ—Ç—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:');
        log('  ‚Ä¢ –•–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ');
        log('  ‚Ä¢ –î–µ—Ä–∂–∏—Ç–µ –∫–∞–º–µ—Ä—É —Ä–æ–≤–Ω–æ');
        log('  ‚Ä¢ –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ 20-40 —Å–º');
      }, 5000);

      // –ï—Å–ª–∏ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ –º–∞—Ä–∫–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω
      setTimeout(() => {
        const video = document.querySelector('video');
        if (cameraReady && video) {
          log('‚ÑπÔ∏è  –ï—Å–ª–∏ –º–∞—Ä–∫–µ—Ä –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç—Å—è:', 'warning');
          log('  1. –°–∫–∞—á–∞–π—Ç–µ –∏ —Ä–∞—Å–ø–µ—á–∞—Ç–∞–π—Ç–µ Hiro –º–∞—Ä–∫–µ—Ä');
          log('  2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ —Ö–æ—Ä–æ—à–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏');
          log('  3. –î–µ—Ä–∂–∏—Ç–µ –º–∞—Ä–∫–µ—Ä —Ä–æ–≤–Ω–æ');
        }
      }, 30000);
    </script>
  </body>
</html>
